<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="File hosting dashboard">
    <title>VaultSphere &mdash; Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/crypto.js') }}"></script>
</head>
<body class="dashboard-body">
    <main class="dashboard-wrapper">
        <header class="dashboard-header glass-panel" aria-labelledby="dashboard-heading">
            <div class="header-top">
                <div class="brand-mark">
                    <span>VaultSphere</span>
                    <strong id="dashboard-heading">Encrypted workspace</strong>
                </div>
                <div class="header-actions">
                    <div class="account-chip" aria-live="polite">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.75 4.75h11.5a1.75 1.75 0 0 1 1.75 1.75v11.5a1.75 1.75 0 0 1-1.75 1.75H4.75A1.75 1.75 0 0 1 3 18V6.5A1.75 1.75 0 0 1 4.75 4.75Z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.25 3H17.5A1.5 1.5 0 0 1 19 4.5V6" opacity="0.5" />
                        </svg>
                        <span id="accountChipNumber">{{ account_number }}</span>
                        <button id="copyAccountBtn" class="icon-button" type="button" aria-label="Copy account number" title="Copy account number">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v2" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16 8h2a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-8a2 2 0 0 1-2-2v-2" />
                            </svg>
                        </button>
                    </div>
                    <button id="logoutBtn" class="btn btn-secondary" type="button">Log out</button>
                </div>
            </div>
            <div class="header-bottom">
                <p class="support-text">You&rsquo;re viewing fully encrypted files. Manage uploads, verify integrity, and stream downloads without exposing your identity.</p>
                <div class="stats-grid">
                    <article class="stat-card">
                        <small>Total files</small>
                        <strong id="totalFilesStat">0</strong>
                        <span class="stat-trend" id="filesTrend">Freshly synced</span>
                    </article>
                    <article class="stat-card">
                        <small>Storage secured</small>
                        <strong id="storageUsedStat">0 B</strong>
                        <span class="stat-trend">Encrypted at rest</span>
                    </article>
                    <article class="stat-card">
                        <small>Integrity checks</small>
                        <strong>SHA-256</strong>
                        <span class="stat-trend">Client-verified</span>
                    </article>
                </div>
            </div>
        </header>

        <section class="glass-panel upload-section" aria-labelledby="upload-heading">
            <div class="upload-stack">
                <div class="section-heading">
                    <h2 id="upload-heading">Upload encrypted files</h2>
                    <div class="helper-row">
                        <span>Drag &amp; drop or choose from your device &middot; up to 5GB</span>
                    </div>
                </div>

                <input type="file" id="fileInput" class="hidden" />

                <div class="upload-dropzone" role="group" aria-labelledby="upload-heading">
                    <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 15a4 4 0 0 1 4-4h.167A4 4 0 0 1 11 5a4 4 0 0 1 3.833 2.667A3.5 3.5 0 0 1 21 10.5a3.5 3.5 0 0 1-3.5 3.5H17" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="m12 12-3 3m3-3 3 3m-3-3v9" />
                    </svg>
                    <p id="fileName">No file selected</p>
                    <div class="upload-actions">
                        <button id="selectFileBtn" type="button" class="btn btn-secondary">Choose file</button>
                        <button id="uploadBtn" type="button" class="btn btn-primary" disabled>
                            <span id="uploadText">Upload &amp; encrypt</span>
                            <span id="uploadSpinner" class="hidden">Uploading...</span>
                        </button>
                    </div>
                </div>

                <div id="uploadProgress" class="upload-progress-panel hidden" aria-live="polite">
                    <div class="helper-row">
                        <span>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" class="animate-spin" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20 9a8 8 0 1 0 0 6" opacity="0.45" />
                            </svg>
                            Uploading...
                        </span>
                        <strong id="uploadPercent">0%</strong>
                    </div>
                    <div class="progress-track">
                        <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
                    </div>
                </div>

                <div id="uploadMessage" class="toast-stack"></div>
            </div>
        </section>

        <section class="glass-panel files-section" aria-labelledby="files-heading">
            <div class="files-stack">
                <div class="files-toolbar">
                    <h2 id="files-heading">Your encrypted files</h2>
                    <div class="files-toolbar-actions">
                        <button id="refreshBtn" class="btn-icon" type="button" aria-label="Refresh files" title="Refresh files">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.418 15A8 8 0 1 1 9 4.582" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="filesContainer" class="file-grid">
                    <div class="loading-state" id="loadingState">
                        <div class="spinner-ring" aria-hidden="true"></div>
                        <p>Decrypting your file index...</p>
                    </div>
                </div>

                <div id="uploadMessageSecondary" class="toast-stack"></div>
            </div>
        </section>

        <footer class="dashboard-footer">All sessions secured with end-to-end encryption. Remember to copy your account number before signing out.</footer>
    </main>

    <script>
        // Get account number from template
        const accountNumber = {{ account_number }};
        
        // Initialize encryption key on page load
        let encryptionKey = null;
        
        async function initializeEncryption() {
            try {
                encryptionKey = await clientCrypto.getOrCreateKey(accountNumber);
                console.log('Encryption key initialized');
            } catch (error) {
                console.error('Failed to initialize encryption:', error);
                showMessage('uploadMessage', 'Failed to initialize encryption. Please refresh the page.', 'error');
            }
        }
        
        // Initialize encryption when page loads
        initializeEncryption();

        // Utility functions
        function showMessage(elementId, message, type = 'error') {
            const element = document.getElementById(elementId);
            const icon = type === 'error'
                ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>'
                : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="m5 13 4 4L19 7" /></svg>';

            element.className = `alert ${type === 'error' ? 'alert-error' : 'alert-success'}`;
            element.innerHTML = `${icon}<span>${message}</span>`;
            element.setAttribute('role', 'alert');
            element.setAttribute('aria-live', 'polite');
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 4800);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeJs(text) {
            return String(text)
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/\t/g, '\\t');
        }

        function formatAccountNumber(number) {
            return String(number).replace(/\B(?=(\d{4})+(?!\d))/g, ' ');
        }

        const accountChipNumber = document.getElementById('accountChipNumber');
        if (accountChipNumber) {
            accountChipNumber.textContent = formatAccountNumber(accountChipNumber.textContent.trim());
        }

        // Copy Account Number
        document.getElementById('copyAccountBtn').addEventListener('click', () => {
            const accountNumber = '{{ account_number }}';
            navigator.clipboard.writeText(accountNumber).then(() => {
                showMessage('uploadMessageSecondary', 'Account number copied to clipboard!', 'success');
            }).catch(() => {
                showMessage('uploadMessageSecondary', 'Failed to copy account number', 'error');
            });
        });

        // File Upload
        document.getElementById('selectFileBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (file) {
                document.getElementById('fileName').textContent = `${file.name} (${formatFileSize(file.size)})`;
                uploadBtn.disabled = false;
            } else {
                document.getElementById('fileName').textContent = 'No file selected';
                uploadBtn.disabled = true;
            }
        });

        async function computeFileHash(file) {
            const hashBuffer = await crypto.subtle.digest('SHA-256', await file.arrayBuffer());
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('uploadMessage', 'Please select a file', 'error');
                return;
            }

            if (!encryptionKey) {
                showMessage('uploadMessage', 'Encryption not initialized. Please refresh the page.', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const uploadText = document.getElementById('uploadText');
            const uploadSpinner = document.getElementById('uploadSpinner');
            
            uploadBtn.disabled = true;
            uploadText.classList.add('hidden');
            uploadSpinner.classList.remove('hidden');

            try {
                // Show progress
                document.getElementById('uploadProgress').classList.remove('hidden');
                document.getElementById('uploadPercent').textContent = '0%';
                document.getElementById('progressBar').style.width = '0%';

                // Encrypt file client-side
                document.getElementById('uploadPercent').textContent = 'Encrypting...';
                const encryptionResult = await clientCrypto.encryptFile(file, encryptionKey);
                
                // Combine IV and encrypted data
                const combinedData = new Uint8Array(encryptionResult.iv.length + encryptionResult.encrypted.length);
                combinedData.set(encryptionResult.iv, 0);
                combinedData.set(encryptionResult.encrypted, encryptionResult.iv.length);
                
                // Compute hash of combined data (for integrity verification)
                const encryptedBlob = new Blob([combinedData]);
                const fileHash = await computeFileHash(encryptedBlob);
                
                // Encrypt metadata (filename, original size, upload date)
                const metadata = {
                    filename: file.name,
                    original_size: file.size,
                    uploaded_at: new Date().toISOString()
                };
                const encryptedMetadata = await clientCrypto.encryptMetadata(metadata, encryptionKey);
                
                // Create blob for upload
                const encryptedFileBlob = new Blob([combinedData], { type: 'application/octet-stream' });
                
                // Update progress
                document.getElementById('uploadPercent').textContent = 'Uploading...';
                document.getElementById('progressBar').style.width = '10%';

                // Upload encrypted file
                const formData = new FormData();
                formData.append('file', encryptedFileBlob, 'encrypted_file');
                formData.append('file_hash', fileHash);
                formData.append('encrypted_metadata', encryptedMetadata);

                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        // Map progress: 10% (encryption) + 90% (upload)
                        const uploadPercent = (e.loaded / e.total) * 90;
                        const totalPercent = 10 + uploadPercent;
                        document.getElementById('uploadPercent').textContent = Math.round(totalPercent) + '%';
                        document.getElementById('progressBar').style.width = totalPercent + '%';
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        
                        // Update local file index
                        const fileIndex = clientCrypto.loadFileIndex(accountNumber);
                        fileIndex.push({
                            file_hash: data.file_hash,
                            encrypted_metadata: encryptedMetadata
                        });
                        clientCrypto.storeFileIndex(accountNumber, fileIndex);
                        
                        showMessage('uploadMessage', 'File encrypted and uploaded successfully!', 'success');
                        document.getElementById('uploadProgress').classList.add('hidden');
                        fileInput.value = '';
                        document.getElementById('fileName').textContent = 'No file selected';
                        uploadBtn.disabled = true;
                        uploadText.classList.remove('hidden');
                        uploadSpinner.classList.add('hidden');
                        loadFiles();
                    } else {
                        const data = JSON.parse(xhr.responseText);
                        showMessage('uploadMessage', data.error || 'Upload failed', 'error');
                        document.getElementById('uploadProgress').classList.add('hidden');
                        uploadText.classList.remove('hidden');
                        uploadSpinner.classList.add('hidden');
                        uploadBtn.disabled = false;
                    }
                });

                xhr.addEventListener('error', () => {
                    showMessage('uploadMessage', 'Network error during upload', 'error');
                    document.getElementById('uploadProgress').classList.add('hidden');
                    uploadText.classList.remove('hidden');
                    uploadSpinner.classList.add('hidden');
                    uploadBtn.disabled = false;
                });

                xhr.open('POST', '/api/upload');
                xhr.send(formData);

            } catch (error) {
                showMessage('uploadMessage', 'Failed to encrypt or upload file: ' + error.message, 'error');
                console.error('Error:', error);
                uploadBtn.disabled = false;
                uploadText.classList.remove('hidden');
                uploadSpinner.classList.add('hidden');
                document.getElementById('uploadProgress').classList.add('hidden');
            }
        });

        // Load Files
        async function loadFiles() {
            const container = document.getElementById('filesContainer');
            container.innerHTML = '<div class="loading-state"><div class="spinner-ring" aria-hidden="true"></div><p>Decrypting your file index...</p></div>';

            if (!encryptionKey) {
                container.innerHTML = '<div class="empty-state"><p>Encryption not initialized.</p><p class="supporting-copy">Please refresh the page.</p></div>';
                return;
            }

            try {
                // Load local file index
                const localFileIndex = clientCrypto.loadFileIndex(accountNumber);
                
                if (localFileIndex.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2Z" />
                            </svg>
                            <div>
                                <p>No files yet &mdash; your vault is waiting.</p>
                                <p class="supporting-copy">Upload your first document to see it appear here instantly.</p>
                            </div>
                        </div>`;
                    document.getElementById('totalFilesStat').textContent = '0';
                    document.getElementById('storageUsedStat').textContent = '0 B';
                    document.getElementById('filesTrend').textContent = 'Ready for your first upload';
                    return;
                }
                
                // Validate with server and get current sizes
                const response = await fetch('/api/files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        encrypted_file_index: localFileIndex
                    })
                });

                const data = await response.json();

                if (data.success && data.files.length > 0) {
                    let totalBytes = 0;
                    
                    // Decrypt metadata and build file list
                    const filePromises = data.files.map(async (file) => {
                        try {
                            const metadata = await clientCrypto.decryptMetadata(file.encrypted_metadata, encryptionKey);
                            totalBytes += file.size_bytes;
                            return {
                                fileHash: file.file_hash,
                                filename: metadata.filename,
                                originalSize: metadata.original_size,
                                uploadedAt: metadata.uploaded_at,
                                sizeBytes: file.size_bytes
                            };
                        } catch (error) {
                            console.error('Failed to decrypt metadata:', error);
                            return null;
                        }
                    });
                    
                    const decryptedFiles = (await Promise.all(filePromises)).filter(f => f !== null);
                    
                    // Update local index if some files were removed server-side
                    if (decryptedFiles.length < localFileIndex.length) {
                        const validHashes = new Set(decryptedFiles.map(f => f.fileHash));
                        const updatedIndex = localFileIndex.filter(entry => validHashes.has(entry.file_hash));
                        clientCrypto.storeFileIndex(accountNumber, updatedIndex);
                    }
                    
                    if (decryptedFiles.length > 0) {
                        container.innerHTML = decryptedFiles.map(file => {
                            return `
                                <article class="file-card">
                                    <div class="file-card-header">
                                        <div class="file-icon">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2Z" />
                                            </svg>
                                        </div>
                                        <div class="file-meta">
                                            <span class="file-name">${escapeHtml(file.filename)}</span>
                                            <span class="file-details">${formatFileSize(file.sizeBytes)}</span>
                                        </div>
                                    </div>
                                    <div class="file-actions">
                                        <button type="button" onclick="downloadFile('${escapeJs(file.fileHash)}', '${escapeJs(file.filename)}')">Download</button>
                                        <button type="button" class="danger" onclick="deleteFile('${escapeJs(file.fileHash)}', '${escapeJs(file.filename)}')">Delete</button>
                                    </div>
                                </article>
                            `;
                        }).join('');

                        document.getElementById('totalFilesStat').textContent = decryptedFiles.length;
                        document.getElementById('storageUsedStat').textContent = formatFileSize(totalBytes);
                        document.getElementById('filesTrend').textContent = decryptedFiles.length === 1 ? '1 file protected' : `${decryptedFiles.length} files protected`;
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2Z" />
                                </svg>
                                <div>
                                    <p>No files yet &mdash; your vault is waiting.</p>
                                    <p class="supporting-copy">Upload your first document to see it appear here instantly.</p>
                                </div>
                            </div>`;
                        document.getElementById('totalFilesStat').textContent = '0';
                        document.getElementById('storageUsedStat').textContent = '0 B';
                        document.getElementById('filesTrend').textContent = 'Ready for your first upload';
                    }
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2Z" />
                            </svg>
                            <div>
                                <p>No files yet &mdash; your vault is waiting.</p>
                                <p class="supporting-copy">Upload your first document to see it appear here instantly.</p>
                            </div>
                        </div>`;
                    document.getElementById('totalFilesStat').textContent = '0';
                    document.getElementById('storageUsedStat').textContent = '0 B';
                    document.getElementById('filesTrend').textContent = 'Ready for your first upload';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><p>Failed to load files.</p><p class="supporting-copy">Please try refreshing.</p></div>';
                console.error('Error:', error);
            }
        }

        // Download File
        window.downloadFile = async function(fileHash, filename) {
            if (!encryptionKey) {
                showMessage('uploadMessageSecondary', 'Encryption not initialized. Please refresh the page.', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/download/${encodeURIComponent(fileHash)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    // Get encrypted file data
                    const encryptedBlob = await response.blob();
                    const encryptedArrayBuffer = await encryptedBlob.arrayBuffer();
                    const encryptedData = new Uint8Array(encryptedArrayBuffer);
                    
                    // Extract IV (first 12 bytes) and encrypted content
                    const iv = encryptedData.slice(0, 12);
                    const encryptedContent = encryptedData.slice(12);
                    
                    // Decrypt file client-side
                    const decryptedBlob = await clientCrypto.decryptFile(
                        encryptedContent,
                        iv,
                        encryptionKey,
                        'application/octet-stream'
                    );
                    
                    // Download decrypted file
                    const url = window.URL.createObjectURL(decryptedBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    showMessage('uploadMessageSecondary', 'File decrypted and downloaded successfully!', 'success');
                } else {
                    const data = await response.json();
                    showMessage('uploadMessageSecondary', data.error || 'Download failed', 'error');
                }
            } catch (error) {
                showMessage('uploadMessageSecondary', 'Failed to decrypt or download file: ' + error.message, 'error');
                console.error('Error:', error);
            }
        };

        // Delete File
        window.deleteFile = async function(fileHash, filename) {
            if (!encryptionKey) {
                showMessage('uploadMessageSecondary', 'Encryption not initialized. Please refresh the page.', 'error');
                return;
            }

            try {
                if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                    return;
                }

                const response = await fetch(`/api/delete/${encodeURIComponent(fileHash)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    // Remove from local index
                    const fileIndex = clientCrypto.loadFileIndex(accountNumber);
                    const updatedIndex = fileIndex.filter(entry => entry.file_hash !== fileHash);
                    clientCrypto.storeFileIndex(accountNumber, updatedIndex);
                    
                    showMessage('uploadMessageSecondary', 'File deleted successfully!', 'success');
                    loadFiles();
                } else {
                    showMessage('uploadMessageSecondary', data.error || 'Delete failed', 'error');
                }
            } catch (error) {
                showMessage('uploadMessageSecondary', 'Failed to delete file: ' + error.message, 'error');
                console.error('Error:', error);
            }
        };

        // Refresh Files
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadFiles();
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/';
            } catch (error) {
                console.error('Error:', error);
                window.location.href = '/';
            }
        });

        // Load files on page load
        loadFiles();
    </script>
</body>
</html>
